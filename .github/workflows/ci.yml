name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      brain: ${{ steps.filter.outputs.brain }}
      core: ${{ steps.filter.outputs.core }}
      node: ${{ steps.filter.outputs.node }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            brain:
              - 'packages/sentinel-brain/**'
            core:
              - 'packages/sentinel-core/**'
            node:
              - 'packages/sentinel-node/**'

  sentinel-brain:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.brain == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    defaults:
      run:
        working-directory: packages/sentinel-brain
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: packages/sentinel-brain/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linter
        run: |
          pip install ruff
          ruff check src/ tests/

      - name: Run type checker
        run: |
          pip install mypy
          mypy src/sentinel_brain --ignore-missing-imports || true

      - name: Run tests
        run: pytest tests/ -v --tb=short

      - name: Run tests with coverage
        if: matrix.python-version == '3.11'
        run: |
          pip install pytest-cov
          pytest tests/ --cov=sentinel_brain --cov-report=xml --cov-report=term-missing

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/sentinel-brain/coverage.xml
          flags: sentinel-brain
          fail_ci_if_error: false

  sentinel-core:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.core == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/sentinel-core
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Forge build
        run: forge build --sizes

      - name: Run Forge tests
        run: forge test -vvv

      - name: Run Forge coverage
        run: forge coverage --report lcov

      - name: Run Forge gas snapshot
        run: forge snapshot

      - name: Check gas snapshot
        run: forge snapshot --check || true

      - name: Run Slither static analysis
        uses: crytic/slither-action@v0.4.0
        continue-on-error: true
        with:
          target: packages/sentinel-core
          sarif: results.sarif

      - name: Upload Slither SARIF
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: results.sarif

  sentinel-node:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.node == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.21', '1.22']
    defaults:
      run:
        working-directory: packages/sentinel-node
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          cache-dependency-path: packages/sentinel-node/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run staticcheck
        uses: dominikh/staticcheck-action@v1
        continue-on-error: true
        with:
          working-directory: packages/sentinel-node

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        if: matrix.go-version == '1.22'
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/sentinel-node/coverage.out
          flags: sentinel-node
          fail_ci_if_error: false

      - name: Build binary
        run: go build -o sentinel ./cmd/sentinel

  integration-test:
    needs: [sentinel-brain, sentinel-core, sentinel-node]
    if: always() && !cancelled() && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Install sentinel-brain
        run: pip install -e packages/sentinel-brain

      - name: Build sentinel-node
        run: |
          cd packages/sentinel-node
          go build -o sentinel ./cmd/sentinel

      - name: Start Anvil
        run: |
          anvil --fork-url https://eth.llamarpc.com --block-time 1 &
          sleep 5

      - name: Deploy contracts
        run: |
          cd packages/sentinel-core
          forge script script/Deploy.s.sol --rpc-url http://localhost:8545 --broadcast || true

      - name: Integration smoke test
        run: |
          echo "Integration tests would run here"
          echo "Verifying all components can start and communicate"
